<!DOCTYPE html>
<html>
  <head>
    <title>Kubernetes K3s Cluster Using K3sup Multi Master</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
<link rel="stylesheet" href="/assets/css/main.css" />
<link rel="stylesheet" href="/assets/css/style.css" />
<link rel="stylesheet" href="/assets/css/navigators/navbar.css" />


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/assets/images/favicon.png" />


<link rel="stylesheet" href="/assets/css/style.css" />

    
<meta name="description" content="summary of blogpost" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/assets/css/single.css" />
<link rel="stylesheet" href="/assets/css/navigators/sidebar.css">


    
    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    <nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
    
    
    
      
    
    
      
    
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="https://blog.internetz.me/">
      <img src="/assets/images/main-logo.png">shit i like</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      </ul>
    </div>
  </div>
  
  <img src="/assets/images/main-logo.png" class="d-none" id="main-logo">
  <img src="/assets/images/inverted-logo.png" class="d-none" id="inverted-logo">
</nav>



      
       

      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://blog.internetz.me/assets/images/default-hero.jpg);'>
      </div>

      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/avatar.png'/>
          <h5 class="author-name">loeken</h5>
          <p>June 8, 2020</p>
        </div>

        <div class="title">
          <h1>Kubernetes K3s Cluster Using K3sup Multi Master</h1>
        </div>

        <div class="post-content" id="post-content">
          <h3 id="getting-started-information">getting started information</h3>
<h5 id="terminology">Terminology</h5>
<ul>
<li>kubernetes: Full blown container orchestration tool</li>
<li>minicube: a 1 node kubernetes cluster running inside a vm ( good for local testing )</li>
<li>k3s a lightweight alternative to Kubernetes  with a lot of unneeded code removed</li>
<li>k3sup a small extra tool that helps you getting your k3s cluster going quickly</li>
</ul>
<h5 id="what-is-this-dockerkuberentes-stuff">What is this docker/kuberentes stuff?</h5>
<style type="text/css">

</style>
<p align="center">
  <iframe
  width="560" 
  height="315"
  src="https://www.youtube.com/embed/1xo-0gCVhTU"
  srcdoc="<style>*{padding:0;margin:0;overflow:hidden}html,body{height:100%}img,span{position:absolute;width:100%;top:0;bottom:0;margin:auto}span{height:1.5em;text-align:center;font:48px/1.5 sans-serif;color:white;text-shadow:0 0 0.5em black}</style><a href=https://www.youtube.com/embed/1xo-0gCVhTU?autoplay=1><img src=https://img.youtube.com/vi/1xo-0gCVhTU/hqdefault.jpg alt='Introduction to micrososervices, docker and kubernetes'><span>▶</span></a>"
  frameborder="0"
  allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
  allowfullscreen
  title="Introduction to micrososervices, docker and kubernetes"
></iframe>
</p>
<h5 id="why-k3s-whats-the-difference-to-kubernetes">Why k3s what&rsquo;s the difference to kubernetes</h5>
<style type="text/css">

</style>
<p align="center">
  <iframe
  width="560" 
  height="315"
  src="https://www.youtube.com/embed/-HchRyqNtkU"
  srcdoc="<style>*{padding:0;margin:0;overflow:hidden}html,body{height:100%}img,span{position:absolute;width:100%;top:0;bottom:0;margin:auto}span{height:1.5em;text-align:center;font:48px/1.5 sans-serif;color:white;text-shadow:0 0 0.5em black}</style><a href=https://www.youtube.com/embed/-HchRyqNtkU?autoplay=1><img src=https://img.youtube.com/vi/-HchRyqNtkU/hqdefault.jpg alt='k3s under the hood'><span>▶</span></a>"
  frameborder="0"
  allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
  allowfullscreen
  title="k3s under the hood"
></iframe>
</p>
<h3 id="prepare-3-virtual-machines">prepare 3 virtual machines</h3>
<p>I span up 3 virtual machines each of them having 2 network interfaces
the first interface has a public ip faceing the internet
the second interface has a private ip connected to an internal vpn. I&rsquo;ve created it like this so i can expose services publicly on the 1 public interface to start with.
while I can use the secondary interface to securely connect to the servers</p>
<p><img src="/media/img/k3s_testlab_01.png" alt="Prepare the Disk">
<a href="/media/imgmarkup/k3s_testlab_01.py">Download Image Markup</a></p>
<p>I used debian 10 netinstaller. these are the dependencies k3s needs in order to run. I created a user called ansible which i ll be using in this tutorial.
the ips of these test vms are in the 192.168.122.0/24 subnet
k3s-01: 10.0.4.82
k3s-02: 10.0.4.83
k3s-03: 10.0.4.84</p>
<pre><code>sudo apt install curl sudo
</code></pre><p>sudo expects to be configured to not use a password we are doing this by editing the /etc/sudoers config</p>
<pre><code>%sudo	ALL=(ALL:ALL) NOPASSWD:ALL
</code></pre><p>now we add the user to the sudo group</p>
<pre><code>usermod -a -G sudo ansible
</code></pre><p>we also transfer our id_rsa.pub onto the 3 vms so we can login. k3sup uses id_rsa.pub/id_rsa it seems
( it did not support my kr ssh agent forwarding )</p>
<pre><code>ssh-copy-id ansible@10.0.4.82
ssh-copy-id ansible@10.0.4.83 
ssh-copy-id ansible@10.0.4.84 
</code></pre><h3 id="installing-k3sup-locally-on-my-workstation">installing k3sup locally on my workstation:</h3>
<pre><code>curl -sLS https://get.k3sup.dev | sh
sudo install k3sup /usr/local/bin/

k3sup --help
</code></pre><h3 id="installation-of-k3s-using-k3sup-on-the-first-virtual-machine">installation of k3s using k3sup on the first virtual machine</h3>
<p>creating the cluster on the first node. this will create a kubeconfig file in the home folder of the user you are running this command from, i ran this from my workstation.
not the added extra &ndash;bind-address and the advertise address params which tells the server to not bind on the ip of the primary but only on the secondary interface
and also to advertise this address to others to be used for communication.</p>
<p>we will be going with version v1.19.1-rc2+k3s1 as it does not have this dqlite crap that keeps on breaking but uses etcd</p>
<pre><code>k3sup install --k3s-version v1.19.1-rc2+k3s1 --ip 10.0.4.82 --user ansible --cluster --k3s-extra-args '--no-deploy=traefik --bind-address=10.0.4.82 --advertise-address=10.0.4.82 --node-ip=10.0.4.82 --node-external-ip 1.2.3.4'
Running: k3sup install
Public IP: 10.0.4.82
ssh -i /home/loeken/.ssh/id_rsa -p 22 ansible@10.0.4.82
ssh: curl -sLS https://get.k3s.io | INSTALL_K3S_EXEC='server --cluster-init --tls-san 10.0.4.82 --bind-address=10.0.4.82 --advertise-address=10.0.4.82 --node-ip=10.0.4.82' INSTALL_K3S_VERSION='v1.17.2+k3s1' sh -

[INFO]  Using v1.17.2+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
[INFO]  systemd: Starting k3s
Result: [INFO]  Using v1.17.2+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
[INFO]  systemd: Starting k3s
 Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.

ssh: sudo cat /etc/rancher/k3s/k3s.yaml

apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJXRENCL3FBREFnRUNBZ0VBTUFvR0NDcUdTTTQ5QkFNQ01DTXhJVEFmQmdOVkJBTU1HR3N6Y3kxelpYSjIKWlhJdFkyRkFNVFU1TVRJNE1qVTVOekFlRncweU1EQTJNRFF4TkRVMk16ZGFGdzB6TURBMk1ESXhORFUyTXpkYQpNQ014SVRBZkJnTlZCQU1NR0dzemN5MXpaWEoyWlhJdFkyRkFNVFU1TVRJNE1qVTVOekJaTUJNR0J5cUdTTTQ5CkFnRUdDQ3FHU000OUF3RUhBMElBQkFoWFlkWW5ZWjVCcVUwS3JhdmpkZVNIQXFJcVNoKzRnT1N0cDFrOUVNQUMKS1RLbyt6RjNoQmZ3UGF4VzRZOHF1Q2hjdDNPZVBPekVvdzAwanFmT0t1MmpJekFoTUE0R0ExVWREd0VCL3dRRQpBd0lDcERBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDL3hYeCthQm5pCmZzUk9kMG53dkczaGlaWURlcmJYK3A1MmgzNVI5QUpYWGdJaEFMcWxkZVZMVXlRR1R3Z1JVY01TYTE0enF1ekQKaUdxc2JQZkViUVZpbHpxRQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://10.0.4.82:6443
  name: default
contexts:
- context:
    cluster: default
    user: default
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: default
  user:
    password: afd3bd64ed2aef936b904d13dee80739
    username: admin
Result: apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJXRENCL3FBREFnRUNBZ0VBTUFvR0NDcUdTTTQ5QkFNQ01DTXhJVEFmQmdOVkJBTU1HR3N6Y3kxelpYSjIKWlhJdFkyRkFNVFU1TVRJNE1qVTVOekFlRncweU1EQTJNRFF4TkRVMk16ZGFGdzB6TURBMk1ESXhORFUyTXpkYQpNQ014SVRBZkJnTlZCQU1NR0dzemN5MXpaWEoyWlhJdFkyRkFNVFU1TVRJNE1qVTVOekJaTUJNR0J5cUdTTTQ5CkFnRUdDQ3FHU000OUF3RUhBMElBQkFoWFlkWW5ZWjVCcVUwS3JhdmpkZVNIQXFJcVNoKzRnT1N0cDFrOUVNQUMKS1RLbyt6RjNoQmZ3UGF4VzRZOHF1Q2hjdDNPZVBPekVvdzAwanFmT0t1MmpJekFoTUE0R0ExVWREd0VCL3dRRQpBd0lDcERBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUFvR0NDcUdTTTQ5QkFNQ0Ewa0FNRVlDSVFDL3hYeCthQm5pCmZzUk9kMG53dkczaGlaWURlcmJYK3A1MmgzNVI5QUpYWGdJaEFMcWxkZVZMVXlRR1R3Z1JVY01TYTE0enF1ekQKaUdxc2JQZkViUVZpbHpxRQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://10.0.4.82:6443
  name: default
contexts:
- context:
    cluster: default
    user: default
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: default
  user:
    password: afd3bd64ed2aef936b904d13dee80739
    username: admin
 
Saving file to: /home/loeken/kubeconfig

# Test your cluster with:
export KUBECONFIG=/home/loeken/kubeconfig
kubectl get node -o wide
</code></pre><p>so we are doing what we are told:</p>
<pre><code>export KUBECONFIG=/home/loeken/kubernetes/kubeconfig                                                                                                                                                                                                                 0.01   12:18  
kubectl get node -o wide
NAME     STATUS   ROLES    AGE     VERSION        INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                       KERNEL-VERSION   CONTAINER-RUNTansible
k3s-01   Ready    master   7m13s   v1.17.2+k3s1   94.23.161.209   &lt;none&gt;        Debian GNU/Linux 10 (buster)   4.19.0-9-amd64   containerd://1.3.3-k3s1
</code></pre><p>this will set the environment variable but this won&rsquo;t remain after reboot so i ll make it persistent via:</p>
<pre><code>echo &quot;export KUBECONFIG=/home/loeken/kubernetes/kubeconfig&quot; &gt;&gt; .zshrc
</code></pre><p>notice that im using the zsh shell if you are not using zsh you might want to use the ~/.bashrc or the ~/.profile file instead</p>
<p>joining in the second node</p>
<pre><code>k3sup join --k3s-version v1.19.1-rc2+k3s1 --ip 10.0.4.83 --server-ip 10.0.4.82 --user ansible --server  --k3s-extra-args '--no-deploy=traefik --bind-address=10.0.4.83 --advertise-address=10.0.4.83 --node-ip=10.0.4.83 --node-external-ip=1.2.3.4'  

Running: k3sup join
Server IP: 10.0.4.82
ssh -i /home/loeken/.ssh/id_rsa -p 22 ansible@10.0.4.82
ssh: sudo cat /var/lib/rancher/k3s/server/node-token

K104c8b3d5e41e6aaf0c5af72ea741ed730b85f6e937244ed2436df5ac3152c38ca::server:feee10ccbf5c359452d0ed73a44396e5
ssh: curl -sfL https://get.k3s.io/ | K3S_URL='https://10.0.4.82:6443' INSTALL_K3S_EXEC='server --server https://10.0.4.82:6443' K3S_TOKEN='K104c8b3d5e41e6aaf0c5af72ea741ed730b85f6e937244ed2436df5ac3152c38ca::server:feee10ccbf5c359452d0ed73a44396e5' INSTALL_K3S_VERSION='v1.17.2+k3s1' sh -s - --bind-address=10.0.4.83 --advertise-address=10.0.4.83 --node-ip=10.0.4.83
[INFO]  Using v1.17.2+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
[INFO]  systemd: Starting k3s
Logs: Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
Output: [INFO]  Using v1.17.2+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
[INFO]  systemd: Starting k3s

</code></pre><p>three times the charm:</p>
<pre><code>k3sup join --k3s-version v1.19.1-rc2+k3s1 --ip 10.0.4.84 --server-ip 10.0.4.82 --user ansible --server  --k3s-extra-args '--no-deploy=traefik --bind-address=10.0.4.84 --advertise-address=10.0.4.84 --node-ip=10.0.4.84 --node-external-ip=1.2.3.4'  

Running: k3sup join
Server IP: 10.0.4.82
ssh -i /home/loeken/.ssh/id_rsa -p 22 ansible@10.0.4.82
ssh: sudo cat /var/lib/rancher/k3s/server/node-token

K104c8b3d5e41e6aaf0c5af72ea741ed730b85f6e937244ed2436df5ac3152c38ca::server:feee10ccbf5c359452d0ed73a44396e5
ssh: curl -sfL https://get.k3s.io/ | K3S_URL='https://10.0.4.82:6443' INSTALL_K3S_EXEC='server --server https://10.0.4.82:6443' K3S_TOKEN='K104c8b3d5e41e6aaf0c5af72ea741ed730b85f6e937244ed2436df5ac3152c38ca::server:feee10ccbf5c359452d0ed73a44396e5' INSTALL_K3S_VERSION='v1.17.2+k3s1' sh -s - --bind-address=10.0.4.84 --advertise-address=10.0.4.84 --node-ip=10.0.4.84
[INFO]  Using v1.17.2+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
[INFO]  systemd: Starting k3s
Logs: Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
Output: [INFO]  Using v1.17.2+k3s1 as release
[INFO]  Downloading hash https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/sha256sum-amd64.txt
[INFO]  Downloading binary https://github.com/rancher/k3s/releases/download/v1.17.2+k3s1/k3s
[INFO]  Verifying binary download
[INFO]  Installing k3s to /usr/local/bin/k3s
[INFO]  Creating /usr/local/bin/kubectl symlink to k3s
[INFO]  Creating /usr/local/bin/crictl symlink to k3s
[INFO]  Creating /usr/local/bin/ctr symlink to k3s
[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
[INFO]  systemd: Enabling k3s unit
[INFO]  systemd: Starting k3s


</code></pre><h3 id="verfiy-that-the-installation-succeeded-and-all-three-nodes-are-up--executing-from-local-pc-">verfiy that the installation succeeded and all three nodes are up ( executing from local pc )</h3>
<pre><code>kubectl get node -o wide
NAME     STATUS   ROLES    AGE     VERSION        INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                       KERNEL-VERSION   CONTAINER-RUNTIME
k3s-02   Ready    master   4m35s   v1.17.2+k3s1   10.0.4.83       &lt;none&gt;        Debian GNU/Linux 10 (buster)   4.19.0-8-amd64   containerd://1.3.3-k3s1
k3s-01   Ready    master   14m     v1.17.2+k3s1   94.23.161.209   &lt;none&gt;        Debian GNU/Linux 10 (buster)   4.19.0-9-amd64   containerd://1.3.3-k3s1
k3s-03   Ready    master   80s     v1.17.2+k3s1   10.0.4.84       &lt;none&gt;        Debian GNU/Linux 10 (buster)   4.19.0-8-amd64   containerd://1.3.3-k3s1
</code></pre><h3 id="installing-the-kubernetes-dashboard">installing the kubernetes dashboard:</h3>
<pre><code>GITHUB_URL=https://github.com/kubernetes/dashboard/releases
VERSION_KUBE_DASHBOARD=$(curl -w '%{url_effective}' -I -L -s -S ${GITHUB_URL}/latest -o /dev/null | sed -e 's|.*/||')
sudo k3s kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/${VERSION_KUBE_DASHBOARD}/aio/deploy/recommended.yaml
</code></pre><p>now we create 2 markups to define the user access to the dashboard1</p>
<pre><code>echo &quot;apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kubernetes-dashboard&quot; &gt; /var/lib/rancher/k3s/server/manifests/dashboard.admin-user.yml

echo &quot;apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kubernetes-dashboard&quot; &gt; /var/lib/rancher/k3s/server/manifests/dashboard.admin-user-role.yml
</code></pre><p>we could have also saved to another folder and manually applied the configuration with</p>
<pre><code>kubectl apply -f dashboard.admin-user.yml
kubectl apply -f dashboard.admin-user-role.yml
</code></pre><p>next step is to get the bearer token which we need to login to the dashboard in the following step</p>
<pre><code>k3s kubectl -n kubernetes-dashboard describe secret admin-user-token | grep ^token
</code></pre><p>now we can access the dashboard via:</p>
<pre><code>https://k3s-01:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/clusterrole?namespace=default
</code></pre><p>create a deployment for nginx:</p>
<pre><code>apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 2 # tells deployment to run 2 pods matching the template
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.16.1
        ports:
        - containerPort: 80
</code></pre><pre><code>kubectl apply -f deployment.yaml
</code></pre>
        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/hossainemruz/toha-example-site/edit/master/content/posts/kubernetes-k3s-cluster-using-k3sup-multi-master.md">
                <i class="fas fa-code-branch"></i>
                Improve This Page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  

  

  

  

  

  

  

  
    
      
      <div class="col-md-6 previous-article">
        <a href="/posts/kubernetes-yaml-configuration-deployment-and-service/" class="btn btn-outline-info">
          <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
          <br />
          <span>Kubernetes Yaml Configuration Deployment and Service</span>
        </a>
      </div>
      
    
    
      
        
        
          
              
          
        
        <div class="col-md-6 next-article">
          <a href="/posts/kubernetes-getting-started/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>Kubernetes Getting Started</span>
          </a>
        </div>
      
    
  

  

  

  

  

  

  

  

  

  

  

</div>

      <hr />
      
      
          <div id="disqus_thread"></div>
<script type="text/javascript">
  (function () {
    
    
    if (window.location.hostname == "localhost") return;

    var dsq = document.createElement("script");
    dsq.type = "text/javascript";
    dsq.async = true;
    var disqus_shortname = "does-not-exist";
    dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
    (
      document.getElementsByTagName("head")[0] ||
      document.getElementsByTagName("body")[0]
    ).appendChild(dsq);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
<a href="https://disqus.com/" class="dsq-brlink"
  >comments powered by <span class="logo-disqus">Disqus</span></a
>

      
      </div>
    </div>
  </div>
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#getting-started-information">getting started information</a>
          <ul>
            <li>
              <ul>
                <li><a href="#terminology">Terminology</a></li>
                <li><a href="#what-is-this-dockerkuberentes-stuff">What is this docker/kuberentes stuff?</a></li>
                <li><a href="#why-k3s-whats-the-difference-to-kubernetes">Why k3s what&rsquo;s the difference to kubernetes</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#prepare-3-virtual-machines">prepare 3 virtual machines</a></li>
        <li><a href="#installing-k3sup-locally-on-my-workstation">installing k3sup locally on my workstation:</a></li>
        <li><a href="#installation-of-k3s-using-k3sup-on-the-first-virtual-machine">installation of k3s using k3sup on the first virtual machine</a></li>
        <li><a href="#verfiy-that-the-installation-succeeded-and-all-three-nodes-are-up--executing-from-local-pc-">verfiy that the installation succeeded and all three nodes are up ( executing from local pc )</a></li>
        <li><a href="#installing-the-kubernetes-dashboard">installing the kubernetes dashboard:</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    <footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#recent-posts">Recent Posts</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#projects">Projects</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#skills">Skills</a>
            </li>
            
        </ul>
        

      </div>
      <div class="col-md-4 col-sm-12">
        <h5>Contact Me</h5>
        <ul>
          
          <li><span>Email: </span> <span>loeken@internetz.me</span></li>
          
        </ul>
      </div>
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/assets/images/inverted-logo.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by Hugo
        <img
          src="/assets/images/hugo-logo-wide.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/assets/js/jquery-3.4.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<script src="/assets/js/navbar.js"></script>
<script src="/assets/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/assets/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


  </body>
</html>
