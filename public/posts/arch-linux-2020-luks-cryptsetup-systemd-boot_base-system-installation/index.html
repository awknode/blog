<!DOCTYPE html>
<html>
  <head>
    <title>Arch Linux 2020 luks cryptsetup systemd-boot installation</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
<link rel="stylesheet" href="/assets/css/main.css" />
<link rel="stylesheet" href="/assets/css/style.css" />
<link rel="stylesheet" href="/assets/css/navigators/navbar.css" />


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/assets/images/favicon.png" />


<link rel="stylesheet" href="/assets/css/style.css" />

    
<meta name="description" content="summary of blogpost" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/assets/css/single.css" />
<link rel="stylesheet" href="/assets/css/navigators/sidebar.css">


    
    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    <nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
    
    
    
      
    
    
      
    
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="https://blog.internetz.me/">
      <img src="/assets/images/main-logo.png">shit i like</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      </ul>
    </div>
  </div>
  
  <img src="/assets/images/main-logo.png" class="d-none" id="main-logo">
  <img src="/assets/images/inverted-logo.png" class="d-none" id="inverted-logo">
</nav>



      
       

      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://blog.internetz.me/assets/images/default-hero.jpg);'>
      </div>

      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/avatar.png'/>
          <h5 class="author-name">loeken</h5>
          <p>May 2, 2020</p>
        </div>

        <div class="title">
          <h1>Arch Linux 2020 luks cryptsetup systemd-boot installation</h1>
        </div>

        <div class="post-content" id="post-content">
          <h3 id="the-video">the video</h3>
<p>the following video whos the whole installation below the video you&rsquo;ll find the transcript</p>
<style type="text/css">

</style>
<p align="center">
  <iframe
  width="560" 
  height="315"
  src="https://www.youtube.com/embed/x4ZFZ9B0t-8"
  srcdoc="<style>*{padding:0;margin:0;overflow:hidden}html,body{height:100%}img,span{position:absolute;width:100%;top:0;bottom:0;margin:auto}span{height:1.5em;text-align:center;font:48px/1.5 sans-serif;color:white;text-shadow:0 0 0.5em black}</style><a href=https://www.youtube.com/embed/x4ZFZ9B0t-8?autoplay=1><img src=https://img.youtube.com/vi/x4ZFZ9B0t-8/hqdefault.jpg alt='test title'><span>▶</span></a>"
  frameborder="0"
  allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
  allowfullscreen
  title="test title"
></iframe>
</p>
<h3 id="getting-the-iso">getting the iso</h3>
<p>you can grab the latest archlinux iso from <a href="https://www.archlinux.org/download/">https://www.archlinux.org/download/</a>
download the iso and the matching signature to verify, if you are doing this from a arch you can use:</p>
<pre><code>pacman-key -v archlinux-2020.05.01-x86_64.iso.sig
==&gt; Checking archlinux-2020.05.01-x86_64.iso.sig... (detached)
gpg: Signatur vom Fr 01 Mai 2020 07:33:57 CEST
gpg:                mittels RSA-Schlüssel 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: Hinweis: Die &quot;trustdb&quot; ist nicht schreibbar
gpg: Korrekte Signatur von &quot;Pierre Schmitz &lt;pierre@archlinux.de&gt;&quot; [vollständig]
</code></pre><p>if not you can also use gpg</p>
<pre><code>gpg --keyserver-options auto-key-retrieve --verify archlinux-2020.05.01-x86_64.iso.sig
</code></pre><h3 id="create-a-bootable-image">create a bootable image</h3>
<p>you can use the tool dd to flash the image to your bootable usb media, plugin the media and run</p>
<pre><code>sudo dmesg
</code></pre><p>dmesg will tell you the device name of the usb stick you just inserted use the sdX in combination with dd to create a bootable image</p>
<pre><code>dd if=/path/to/arch.iso of=/dev/sdX
</code></pre><h3 id="boot-from-the-image">boot from the image</h3>
<p>you will end up with a prompt as the root user</p>
<p>load your keyboard layout ( i ll be picking the german keyboard layout de-latin1 the default is us layout)</p>
<pre><code>loadkeys de-latin1
</code></pre><p>verify that uefi has been loaded properly</p>
<pre><code>ls /sys/firmware/efi/efivars
</code></pre><p>Connect to the internet - most cases you will get an ip via dhcp so lets use dhclient to get an ip.</p>
<p>In most cases this will be dhclient eth0</p>
<pre><code>dhclient enp1s0
</code></pre><h3 id="update-the-system-clock">update the system clock</h3>
<pre><code>timedatectl set-ntp true
</code></pre><h3 id="prepare-the-disk">prepare the disk</h3>
<p><img src="/media/img/arch_installation_partition_with_fstab.png" alt="Prepare the Disk"></p>
<h3 id="create-encrypted-lvm">Create encrypted lvm</h3>
<p>modprobing dm-crypt which is used to encrypt our disks</p>
<pre><code>modprobe dm-crypt
</code></pre><p>you can use the following command to find out the throughput of various ciphers</p>
<pre><code>cryptsetup benchmark
</code></pre><p>next step is to create the encryption il lb e using  aes-xts-plain with 512 bits</p>
<pre><code>cryptsetup -c aes-xts-plain -y -s 512 luksFormat /dev/vda2
</code></pre><p>now lets open the container so we can start using the newly created /dev/mapper/lvm device</p>
<pre><code>cryptsetup luksOpen /dev/vda2 lvm
</code></pre><p>now we are going to create the logical volume groups</p>
<pre><code>pvcreate /dev/mapper/lvm
vgcreate main /dev/mapper/lvm
</code></pre><p>and now we can create the actual volume groups we ll need one for root and one for the swap, for some people it might be useful to also create one for /var or for /home</p>
<pre><code>lvcreate -L 2GB -n swap main
lvcreate -l 100%FREE -n root main
</code></pre><h3 id="create--the-filesystems">create  the filesystems</h3>
<pre><code>mkfs.vfat -n BOOT /dev/vda1
mkfs.ext4 -L root /dev/mapper/main-root
mkswap -L swap /dev/mapper/main-swap
</code></pre><h3 id="now-we-can-mount-the-disks">now we can mount the disks</h3>
<pre><code>mount /dev/mapper/main-root /mnt
mkdir /mnt/boot
mount /dev/vda1 /mnt/boot
</code></pre><h3 id="installing-the-actual-base">installing the actual base</h3>
<p>we are now using pacstrap to install into the  /mnt folder where we mounted the lvms to in the last step. ( i have an intel based cpu so i ll be picking the intel-uc package )</p>
<pre><code>pacstrap /mnt base base-devel syslinux nano linux linux-firmware mkinitcpio lvm2 dhcpcd inetutils intel-ucode
syslinux-install_update -i -a -m -c /mnt
</code></pre><p>in the next step we have to add one of these append lines to each the arch and the fallback definition</p>
<pre><code>nano /mnt/boot/syslinux/syslinux.cfg
</code></pre><pre><code>APPEND cryptdevice=/dev/vda2:main root=/dev/mapper/main-root rw lang=de locale=de_DE.UTF-8
</code></pre><h3 id="make-the-mounts-persistent">make the mounts persistent</h3>
<p>we already mounted all partitions except the swap let&rsquo;s mount the swap now then we can generate an fstab file based on all the mounted partitions</p>
<pre><code>swapon -L swap
</code></pre><p>now generate the fstab file and verify with cat</p>
<pre><code>genfstab -U -p /mnt &gt;&gt; /mnt/etc/fstab
nano /mnt/etc/fstab
</code></pre><p>when using an ssd we append to each disk</p>
<pre><code>,noatime,discard
</code></pre><p>for me this resulted in this fstab file</p>
<p><img src="/media/img/linux_arch_fstab_example_for_ssds.png" alt="arch fstab example for ssds"></p>
<h3 id="finishing-touches-on-the-installation">finishing touches on the installation</h3>
<p>the power of chmod - we previsouly installed arch onto /mnt so we now chroot into this directory. so we can start executing commands as if /mnt was our /</p>
<pre><code>arch-chroot /mnt
</code></pre><p>set the LANG and make it persistent by saving it to the locale.conf</p>
<pre><code>echo LANG=de_DE.UTF-8 &gt; /etc/locale.conf
</code></pre><p>nwo open the local.gen and uncomment all the languages you plan on using for me it&rsquo;s de_DE.UTF-8</p>
<pre><code>nano /etc/locale.gen
de_DE.UTF-8 UTF-8
#de_DE ISO-8859-1
#de_DE@euro ISO-8859-15
</code></pre><p>afterwards you can regenerate the local files</p>
<pre><code>locale-gen
Generating locales...
de_DE.UTF-8... done
de_DE.ISO-8859-1... done
de_DE.ISO-8859-15@euro... done
Generation complete.
</code></pre><pre><code>echo KEYMAP=de-latin1 &gt; /etc/vconsole.conf
echo FONT=lat9w-16 &gt;&gt; /etc/vconsole.conf
</code></pre><p>And now we are going to save our localtime</p>
<pre><code>ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime
</code></pre><p>Turn on multilib by uncommenting the lines in /etc/pacman.conf</p>
<pre><code>[multilib]
SigLevel = PackageRequired TrustedOnly
require_once = /etc/pacman.d/mirrorlist
</code></pre><p>and upgrade the packages for multilib</p>
<pre><code>pacman -Sy
</code></pre><p>now we have to modify the loading of modules/hooks via nano /etc/mkinitcpio.conf we need lvm2 and encrypt</p>
<pre><code>MODULES=(ext4)
HOOKS=(base udev autodetect modconf block keyboard encrypt lvm2 filesystems fsck)
</code></pre><h3 id="bake-that-kernel">bake that kernel</h3>
<p>let&rsquo;s generate a new kernel image</p>
<pre><code>mkinitcpio -p linux
</code></pre><p>define root-passwort festlegen:</p>
<pre><code>passwd
</code></pre><p>turn on dhcpd so arch will get an ip on the next startup</p>
<pre><code>systemctl enable dhcpcd.service
</code></pre><p>now we define a hostname and write the /etc/hosts file</p>
<pre><code>hostnamectl set-hostname archtest
echo &quot;127.0.0.1 archtest&quot; &gt;&gt; /etc/hosts
</code></pre><h3 id="bootload-systemd">bootload systemd</h3>
<pre><code>bootctl --path=/boot install
</code></pre><p>now we are going to edit /boot/loader/loader.conf</p>
<pre><code>#timeout 3
#console-mode keep
</code></pre><p>now we are going to add an entry /boot/loader/entries/arch.conf</p>
<pre><code>title	Arch Linux
linux	/vmlinuz-linux
initrd /intel-ucode.img
initrd /initramfs-linux.img
options cryptdevice=UUID=8ef2ef04-a712-4a5a-84aa-32c4d87cff90:lvm root=/dev/mapper/main-root quiet rw

</code></pre><p>set a hostname</p>
<pre><code>echo &quot;archtest&quot; &gt; /etc/hostname
echo &quot;127.0.0.1	localhost&quot; &gt; /etc/hostname
echo &quot;::1		localhost&quot; &gt;&gt; /etc/hostname
echo &quot;127.0.0.1 archtest.localhdomain archtest&quot; &gt;&gt; /etc/hostname
</code></pre><p>leave the chroot umount the disks and reboot</p>
<pre><code>exit
umount /mnt/{boot,}
reboot
</code></pre>
        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/hossainemruz/toha-example-site/edit/master/content/posts/arch-linux-2020-luks-cryptsetup-systemd-boot_base-system-installation.md">
                <i class="fas fa-code-branch"></i>
                Improve This Page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  
    
      
      <div class="col-md-6 previous-article">
        <a href="/posts/arch-linux-2020-i3wm-polybar-rofi-picom/" class="btn btn-outline-info">
          <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
          <br />
          <span>Arch Linux 2020 i3wm polybar rofi picom</span>
        </a>
      </div>
      
    
    
      
        
        
          
              
          
        
        <div class="col-md-6 next-article">
          <a href="/posts/jenkins_installation_setup_multibranch_pipelines_in_docker/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>Jenkins installation in Docker</span>
          </a>
        </div>
      
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</div>

      <hr />
      
      
          <div id="disqus_thread"></div>
<script type="text/javascript">
  (function () {
    
    
    if (window.location.hostname == "localhost") return;

    var dsq = document.createElement("script");
    dsq.type = "text/javascript";
    dsq.async = true;
    var disqus_shortname = "does-not-exist";
    dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
    (
      document.getElementsByTagName("head")[0] ||
      document.getElementsByTagName("body")[0]
    ).appendChild(dsq);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
<a href="https://disqus.com/" class="dsq-brlink"
  >comments powered by <span class="logo-disqus">Disqus</span></a
>

      
      </div>
    </div>
  </div>
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#the-video">the video</a></li>
        <li><a href="#getting-the-iso">getting the iso</a></li>
        <li><a href="#create-a-bootable-image">create a bootable image</a></li>
        <li><a href="#boot-from-the-image">boot from the image</a></li>
        <li><a href="#update-the-system-clock">update the system clock</a></li>
        <li><a href="#prepare-the-disk">prepare the disk</a></li>
        <li><a href="#create-encrypted-lvm">Create encrypted lvm</a></li>
        <li><a href="#create--the-filesystems">create  the filesystems</a></li>
        <li><a href="#now-we-can-mount-the-disks">now we can mount the disks</a></li>
        <li><a href="#installing-the-actual-base">installing the actual base</a></li>
        <li><a href="#make-the-mounts-persistent">make the mounts persistent</a></li>
        <li><a href="#finishing-touches-on-the-installation">finishing touches on the installation</a></li>
        <li><a href="#bake-that-kernel">bake that kernel</a></li>
        <li><a href="#bootload-systemd">bootload systemd</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    <footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#recent-posts">Recent Posts</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#projects">Projects</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#skills">Skills</a>
            </li>
            
        </ul>
        

      </div>
      <div class="col-md-4 col-sm-12">
        <h5>Contact Me</h5>
        <ul>
          
          <li><span>Email: </span> <span>loeken@internetz.me</span></li>
          
        </ul>
      </div>
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/assets/images/inverted-logo.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by Hugo
        <img
          src="/assets/images/hugo-logo-wide.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/assets/js/jquery-3.4.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<script src="/assets/js/navbar.js"></script>
<script src="/assets/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/assets/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


  </body>
</html>
